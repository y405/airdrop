name: Malware Guard

on:
  push:
    branches: [main, master, develop, "release/**"]
  pull_request:

jobs:
  scan:
    name: Security scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Scan for malicious patterns
        run: |
          set -euo pipefail
          BLOCKED=0

          # ─── 1. Config files: no dynamic code execution ───
          CONFIG_FILES=$(find . -type f \( \
            -name "next.config.*" -o \
            -name "vite.config.*" -o \
            -name "postcss.config.*" -o \
            -name "tailwind.config.*" -o \
            -name "webpack.config.*" -o \
            -name "babel.config.*" -o \
            -name "rollup.config.*" -o \
            -name "esbuild.config.*" -o \
            -name "jest.config.*" -o \
            -name "vitest.config.*" -o \
            -name "tsconfig*.json" -o \
            -name ".babelrc" -o \
            -name ".swcrc" \
          \) -not -path "*/node_modules/*" || true)

          for file in $CONFIG_FILES; do
            [ ! -f "$file" ] && continue

            # Code execution
            if grep -qE 'eval\s*\(' "$file"; then
              echo "::error file=$file::eval() in config file"
              BLOCKED=1
            fi
            if grep -qE 'new\s+Function\s*\(' "$file"; then
              echo "::error file=$file::new Function() in config file"
              BLOCKED=1
            fi
            if grep -qE 'atob\s*\(' "$file"; then
              echo "::error file=$file::atob() in config file"
              BLOCKED=1
            fi

            # Process execution
            if grep -qE 'child_process|\.spawn\s*\(|\.execSync\s*\(|\.exec\s*\(' "$file"; then
              echo "::error file=$file::Process execution in config file"
              BLOCKED=1
            fi

            # Network calls (configs should never fetch)
            if grep -qE "require\s*\(\s*['\"]https?['\"]|\.request\s*\(\s*['\"]http" "$file"; then
              echo "::error file=$file::Network request in config file"
              BLOCKED=1
            fi

            # Payload concealment
            if awk 'length > 500 { found=1 } END { exit !found }' "$file" 2>/dev/null; then
              echo "::error file=$file::Line > 500 chars (payload concealment)"
              BLOCKED=1
            fi
            if grep -qE '[A-Za-z0-9+/]{200,}' "$file"; then
              echo "::error file=$file::Large encoded blob"
              BLOCKED=1
            fi
            if grep -qE "Buffer\.from\s*\(.*['\"]hex['\"]" "$file"; then
              echo "::error file=$file::Buffer.from(hex) in config"
              BLOCKED=1
            fi
            if grep -qP '\S\s{50,}$' "$file" 2>/dev/null; then
              echo "::error file=$file::Excessive trailing whitespace (payload concealment)"
              BLOCKED=1
            fi
          done

          # ─── 2. All JS/TS files: obfuscation + known signatures ───
          JS_FILES=$(find . -type f \( -name "*.ts" -o -name "*.js" -o -name "*.mjs" -o -name "*.cjs" -o -name "*.tsx" -o -name "*.jsx" \) \
            -not -path "*/node_modules/*" -not -path "*/.next/*" -not -path "*/dist/*" -not -path "*/build/*" || true)

          for file in $JS_FILES; do
            [ ! -f "$file" ] && continue

            # Shai-Hulud signature (split to avoid self-detection)
            SIGPAT="global\[._V"
            SIGPAT="${SIGPAT}.\]"
            if grep -qE "$SIGPAT" "$file" 2>/dev/null; then
              echo "::error file=$file::Shai-Hulud malware signature"
              BLOCKED=1
            fi

            # Obfuscator.io output (variable names like _0x4a3b)
            if grep -cE '\b_0x[0-9a-f]{4,}\b' "$file" 2>/dev/null | grep -qE '^[5-9]|^[0-9]{2,}'; then
              echo "::error file=$file::Obfuscated code detected (5+ _0x variables)"
              BLOCKED=1
            fi

            # String.fromCharCode with many args (obfuscation)
            if grep -qE 'String\.fromCharCode\s*\((\s*\d+\s*,){10,}' "$file" 2>/dev/null; then
              echo "::error file=$file::String.fromCharCode obfuscation (10+ args)"
              BLOCKED=1
            fi

            # Bracket notation on common dangerous APIs (obfuscation bypass)
            if grep -qE "this\[.eval.\]|window\[.eval.\]|global\[.eval.\]" "$file" 2>/dev/null; then
              echo "::error file=$file::Bracket-notation eval (obfuscation)"
              BLOCKED=1
            fi
          done

          # ─── 3. package.json: suspicious lifecycle scripts ───
          PKG_FILES=$(find . -name "package.json" -not -path "*/node_modules/*" || true)

          for file in $PKG_FILES; do
            [ ! -f "$file" ] && continue

            # postinstall/preinstall that run node -e, curl, wget, or encoded payloads
            if grep -qE '"(pre|post)install"\s*:\s*"[^"]*\b(node\s+-e|curl\s|wget\s|bash\s+-c|sh\s+-c|eval|atob)' "$file" 2>/dev/null; then
              echo "::error file=$file::Suspicious install script"
              BLOCKED=1
            fi
          done

          # ─── Result ───
          if [ "$BLOCKED" -eq 1 ]; then
            echo ""
            echo "::error::Malware patterns detected. Push blocked."
            exit 1
          fi

          echo "All files clean."
