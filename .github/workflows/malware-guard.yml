name: Malware Guard

on:
  push:
    branches: [main, develop, "release/**"]
  pull_request:

jobs:
  scan:
    name: Config file scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Scan config files for malicious patterns
        run: |
          set -euo pipefail
          BLOCKED=0

          CONFIG_FILES=$(find . -type f \( \
            -name "next.config.*" -o \
            -name "vite.config.*" -o \
            -name "postcss.config.*" -o \
            -name "tailwind.config.*" -o \
            -name "webpack.config.*" -o \
            -name "babel.config.*" -o \
            -name "rollup.config.*" -o \
            -name "esbuild.config.*" -o \
            -name "jest.config.*" -o \
            -name "vitest.config.*" -o \
            -name "tsconfig*.json" \
          \) -not -path "*/node_modules/*" || true)

          for file in $CONFIG_FILES; do
            [ ! -f "$file" ] && continue

            # eval()
            if grep -qE 'eval\s*\(' "$file"; then
              echo "::error file=$file::eval() found in config file"
              BLOCKED=1
            fi

            # atob()
            if grep -qE 'atob\s*\(' "$file"; then
              echo "::error file=$file::atob() found in config file"
              BLOCKED=1
            fi

            # Lines > 500 chars
            if awk 'length > 500 { found=1 } END { exit !found }' "$file" 2>/dev/null; then
              echo "::error file=$file::Line exceeds 500 characters (payload concealment)"
              BLOCKED=1
            fi

            # child_process / spawn / exec
            if grep -qE 'child_process|require\s*\(\s*["\x27]child_process|\.spawn\s*\(|\.execSync\s*\(' "$file"; then
              echo "::error file=$file::Process execution found in config file"
              BLOCKED=1
            fi

            # Large base64 blob (> 200 chars)
            if grep -qE '[A-Za-z0-9+/]{200,}' "$file"; then
              echo "::error file=$file::Large encoded blob detected"
              BLOCKED=1
            fi

            # Buffer.from with hex
            if grep -qE "Buffer\.from\s*\(.*['\"]hex['\"]" "$file"; then
              echo "::error file=$file::Buffer.from(hex) in config file"
              BLOCKED=1
            fi

            # Excessive trailing whitespace
            if grep -qP '\S\s{50,}$' "$file" 2>/dev/null; then
              echo "::error file=$file::Excessive trailing whitespace (payload concealment)"
              BLOCKED=1
            fi
          done

          # Universal: Shai-Hulud signature in any file (pattern split to avoid self-detection)
          SIGPAT="global\[._V"
          SIGPAT="${SIGPAT}.\]"
          SIGNATURE=$(grep -rl "$SIGPAT" --include="*.ts" --include="*.js" --include="*.mjs" --include="*.cjs" . 2>/dev/null | grep -v node_modules || true)
          if [ -n "$SIGNATURE" ]; then
            for file in $SIGNATURE; do
              echo "::error file=$file::Shai-Hulud malware signature detected"
            done
            BLOCKED=1
          fi

          if [ "$BLOCKED" -eq 1 ]; then
            echo ""
            echo "::error::Malware patterns detected. Push blocked."
            exit 1
          fi

          echo "All config files clean."
